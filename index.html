<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת סידור עבודה עם Google Sheets והשוואת חילנט</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set the worker source for PDF.js to avoid warnings
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body class="bg-slate-100 p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-6">
            <img id="logo-img" src="https://placehold.co/200x80/e0e7ff/3730a3?text=הלוגו+שלך" alt="Logo" class="h-16 w-auto mx-auto mb-4 rounded-md">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">מערכת סידור משמרות</h1>
            <p class="text-slate-600 mt-2 text-lg">הנתונים נשמרים ונקראים ישירות מ-Google Sheets.</p>
        </div>

        <div class="card flex flex-col md:flex-row justify-between items-center gap-4">
            <div id="auth-section" class="flex items-center gap-3">
                <button id="authorize_button" class="btn btn-blue" disabled>התחבר/אשר עם Google</button>
                <button id="signout_button" class="btn btn-red hidden">התנתק</button>
            </div>
            <div id="status-indicator" class="flex items-center gap-2 text-sm text-slate-500 p-2 rounded-md"></div>
        </div>

        <div id="app-content" class="hidden">
            <div class="card flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <label for="date-picker" class="font-semibold text-slate-700">בחר שבוע:</label>
                    <input type="date" id="date-picker" class="p-2 border border-slate-300 rounded-md">
                </div>
                <div class="flex items-center gap-3 flex-wrap justify-center">
                    <button id="reset-btn" class="btn btn-red text-sm py-2 px-4">אפס שבוע</button>
                    <button id="send-email-btn" class="btn btn-blue">שלח במייל</button>
                    <button id="download-excel-btn" class="btn btn-green">ייצוא ל-Excel</button>
                    <button id="copy-previous-week-btn" class="btn btn-blue">העתק שבוע קודם</button>
                    <button id="create-calendar-events-btn" class="btn btn-blue">צור אירועי יומן 📅</button>
                    <button id="delete-calendar-events-btn" class="btn btn-red">מחק אירועי יומן 🗑️</button>
                    <button id="refresh-data-btn" class="btn btn-slate">רענן נתונים 🔄</button>
                    <button id="vacation-shift-btn" class="btn btn-blue">חופש מאור/מור 🏖️</button>
                    <a href="https://assuta.net.hilan.co.il/login" target="_blank" class="btn btn-orange">פתח אתר חילנט</a>
                    <input type="file" id="upload-hilanet-input" accept=".pdf, .xlsx, .xls" class="hidden">
                    <button id="upload-hilanet-btn" class="btn btn-purple">העלה קובץ מחילנט</button>
                    <input type="file" id="upload-image-input" accept="image/*" class="hidden">
                    <button id="upload-image-btn" class="btn btn-cyan">העלה תמונה של סידור 🖼️</button>
                    <button id="show-chart-btn" class="btn btn-green">הצג גרף משמרות 📊</button>
                    <button id="send-friday-summary-btn" class="btn btn-purple">שלח סיכום ימי שישי</button>
                </div>
            </div>

            <div id="schedule-card" class="card">
                <h2 id="schedule-title" class="text-2xl font-semibold mb-4 text-slate-700 text-center"></h2>
                <div class="overflow-x-auto">
                    <table id="schedule-table" class="w-full text-center text-slate-700 border-collapse">
                        <thead class="bg-slate-200">
                            <tr>
                                <th class="p-3 border border-slate-300">יום</th>
                                <th class="p-3 border border-slate-300">תאריך</th>
                                <th class="p-3 border border-slate-300">משמרת בוקר</th>
                                <th class="p-3 border border-slate-300">משמרת ערב</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body" class="bg-white">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="differences-container" class="card hidden relative">
                <div id="hourglass-loader" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 rounded-xl">
                    <p class="text-center font-semibold text-slate-600 mb-2">מייבא משמרות ושומר...</p>
                    <div class="hourglassBackground">
                        <div class="hourglassContainer">
                            <div class="hourglassCurves"></div>
                            <div class="hourglassCapTop"></div>
                            <div class="hourglassGlassTop"></div>
                            <div class="hourglassSand"></div>
                            <div class="hourglassSandStream"></div>
                            <div class="hourglassCapBottom"></div>
                            <div class="hourglassGlass"></div>
                        </div>
                    </div>
                </div>

                <ol id="analysis-stepper" class="items-center w-full space-y-4 sm:flex sm:space-x-8 sm:space-y-0 rtl:space-x-reverse hidden mb-6">
                    <li id="step-1" class="flex items-center text-gray-500 dark:text-gray-400 space-x-2.5 rtl:space-x-reverse">
                        <span class="flex items-center justify-center w-8 h-8 border rounded-full shrink-0">1</span>
                        <span><h3 class="font-medium leading-tight">העלאת קובץ</h3><p class="text-sm">הקובץ נטען</p></span>
                    </li>
                    <li id="step-2" class="flex items-center text-gray-500 dark:text-gray-400 space-x-2.5 rtl:space-x-reverse">
                        <span class="flex items-center justify-center w-8 h-8 border rounded-full shrink-0">2</span>
                        <span><h3 class="font-medium leading-tight">חילוץ נתונים</h3><p class="text-sm">AI מנתח את התמונה</p></span>
                    </li>
                    <li id="step-3" class="flex items-center text-gray-500 dark:text-gray-400 space-x-2.5 rtl:space-x-reverse">
                        <span class="flex items-center justify-center w-8 h-8 border rounded-full shrink-0">3</span>
                        <span><h3 class="font-medium leading-tight">השוואה</h3><p class="text-sm">הצגת פערים</p></span>
                    </li>
                </ol>
                <h3 class="text-xl font-bold mb-4 text-slate-800">השוואת סידורים</h3>
                <div id="differences-modal-status" class="text-center text-sm font-medium mb-4"></div>
                <div id="differences-display" class="text-sm text-slate-700 mb-4 overflow-x-auto"></div>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button id="close-differences-btn" class="btn btn-slate">הסתר השוואה</button>
                    <button id="download-differences-btn" class="btn btn-green">הורד קובץ פערים (CSV)</button>
                    <button id="import-selected-hilanet-shifts-btn" class="btn btn-purple">יבא משמרות נבחרות</button>
                </div>
            </div>
            <div class="chart-container-wrapper">
                <div id="chart-card" class="card hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-700 text-center">גרף התפלגות משמרות שבועית</h2>
                    <div class="chart-container">
                        <canvas id="shift-chart"></canvas>
                    </div>
                </div>

                <div id="monthly-summary-chart-card" class="card hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-700 text-center">סיכום משמרות חודשי לעובד</h2>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <div class="flex-grow w-full sm:w-auto">
                            <label for="monthly-summary-employee-select" class="block text-sm font-medium text-slate-700 mb-2">בחר עובד:</label>
                            <select id="monthly-summary-employee-select" class="p-2 border border-slate-300 rounded-md w-full max-w-xs"></select>
                        </div>
                        <div id="month-selector-container" class="flex-grow w-full sm:w-auto hidden">
                            <label for="monthly-summary-month-select" class="block text-sm font-medium text-slate-700 mb-2">בחר חודש:</label>
                            <select id="monthly-summary-month-select" class="p-2 border border-slate-300 rounded-md w-full max-w-xs"></select>
                        </div>
                    </div>
                    <div class="flex justify-center gap-3 mb-6">
                         <button id="export-monthly-summary-btn" class="btn btn-green">ייצא נתונים</button>
                         <button id="analyze-monthly-summary-btn" class="btn btn-purple">קבל תובנות AI</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthly-summary-chart"></canvas>
                    </div>
                    <div id="monthly-analysis-container" class="mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                        <h4 class="font-semibold text-lg text-slate-800 mb-2">תובנות על החודש</h4>
                        <div id="monthly-analysis-content" class="text-slate-600 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="shift-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-6 text-center text-slate-800"></h3>
            <div id="modal-options" class="space-y-3"></div>
            <button id="gemini-suggestion-btn" class="mt-4 w-full btn btn-purple">הצע לי שיבוץ לעובד</button>
            <div class="space-y-4 mt-4">
                <div>
                    <label for="shift-start-time" class="block text-sm font-medium text-slate-700">שעת התחלה:</label>
                    <input type="time" id="shift-start-time" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="shift-end-time" class="block text-sm font-medium text-slate-700">שעת סיום:</label>
                    <input type="time" id="shift-end-time" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex gap-4">
                <button id="modal-close-btn" class="w-full btn btn-slate">ביטול</button>
                <button id="modal-save-btn" class="w-full btn btn-blue">שמור</button>
            </div>
        </div>
    </div>

    <div id="employee-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="employee-selection-modal-title" class="text-xl font-bold mb-6 text-center text-slate-800">בחר עובדים</h3>
            <div id="employee-checkboxes-container" class="space-y-3 mb-6"></div>
            <div class="flex justify-center gap-4">
                <button id="employee-selection-cancel-btn" class="btn btn-slate px-6 py-2">ביטול</button>
                <button id="employee-selection-confirm-btn" class="btn btn-blue px-6 py-2">אישור</button>
            </div>
        </div>
    </div>

    <div id="vacation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-6 text-center text-slate-800">הגדר חופשה לעובד</h3>
            <div class="space-y-4">
                <div>
                    <label for="vacation-employee-select" class="block text-sm font-medium text-slate-700">בחר עובד:</label>
                    <select id="vacation-employee-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                        <option value="">בחר עובד</option>
                    </select>
                </div>
                <div>
                    <label for="vacation-start-date" class="block text-sm font-medium text-slate-700">תאריך התחלה:</label>
                    <input type="date" id="vacation-start-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="vacation-end-date" class="block text-sm font-medium text-slate-700">תאריך סיום:</label>
                    <input type="date" id="vacation-end-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button id="vacation-cancel-btn" class="btn btn-slate px-6 py-2">ביטול</button>
                <button id="vacation-confirm-btn" class="btn btn-blue px-6 py-2">שבץ חופשה</button>
            </div>
        </div>
    </div>

    <div id="image-metadata-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-6 text-center text-slate-800">פרטי סידור העבודה שבתמונה</h3>
            <div class="space-y-4">
                <div>
                    <label for="image-employee-select" class="block text-sm font-medium text-slate-700">עובד:</label>
                    <select id="image-employee-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                        <option value="מאור" selected>מאור</option>
                    </select>
                </div>
                <div>
                    <label for="image-month-select" class="block text-sm font-medium text-slate-700">חודש:</label>
                    <select id="image-month-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select>
                </div>
                <div>
                    <label for="image-year-select" class="block text-sm font-medium text-slate-700">שנה:</label>
                    <select id="image-year-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button id="image-metadata-cancel-btn" class="btn btn-slate px-6 py-2">ביטול</button>
                <button id="image-metadata-confirm-btn" class="btn btn-blue px-6 py-2">המשך לניתוח</button>
            </div>
        </div>
    </div>
    
    <div id="friday-summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-6 text-center text-slate-800">בחירת טווח תאריכים לסיכום</h3>
            <div class="space-y-4">
                <div>
                    <label for="summary-start-date" class="block text-sm font-medium text-slate-700">מתאריך:</label>
                    <input type="date" id="summary-start-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="summary-end-date" class="block text-sm font-medium text-slate-700">עד תאריך:</label>
                    <input type="date" id="summary-end-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button id="summary-cancel-btn" class="btn btn-slate px-6 py-2">ביטול</button>
                <button id="summary-confirm-btn" class="btn btn-blue px-6 py-2">שלח סיכום</button>
            </div>
        </div>
    </div>

    <div id="email-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="email-selection-modal-title" class="text-xl font-bold mb-6 text-center text-slate-800">בחר נמען למייל</h3>
            <div id="email-options-container" class="space-y-3 mb-6">
                </div>
            <div id="other-email-container" class="hidden mt-4">
                <label for="other-email-input" class="block text-sm font-medium text-slate-700">כתובת מייל:</label>
                <input type="email" id="other-email-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" placeholder="example@email.com">
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="email-selection-cancel-btn" class="btn btn-slate px-6 py-2">ביטול</button>
                <button id="email-selection-confirm-btn" class="btn btn-blue px-6 py-2">שלח</button>
            </div>
        </div>
    </div>

    <script type="module" src="JS/main.js"></script>
</body>
</html>